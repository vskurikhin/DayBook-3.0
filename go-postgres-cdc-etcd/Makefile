default: init

.PHONY: init
init: init/lint

.PHONY: init/lint  init/vulnCheck
init/lint:
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.59.1
	go install golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment@v0.22.0

.PHONY: init/vulnCheck
init/vulnCheck:
	go install golang.org/x/vuln/cmd/govulncheck@latest

.PHONY: audit
audit: vendor
	@echo 'Formatting code...'
	fieldalignment -fix ./...
	golangci-lint run -c .golangci.yml --timeout=5m -v --fix
	@echo 'Vetting code...'
	go vet ./...
	@echo 'Vulnerability scanning...'
	govulncheck ./...

.PHONY: tidy
tidy:
	@echo 'Tidying and verifying module dependencies...'
	go mod tidy -compat=1.22.4
	go mod verify

.PHONY: tidy/all
tidy/all:
	go mod tidy
	cd integration_test && go mod tidy && cd ../

.PHONY: test/integration
test/integration:
	cd integration_test && go test -race -p=1 -v ./...

.PHONY: lint
lint: init/lint
	@echo 'Formatting code...'
	fieldalignment -fix ./...
	golangci-lint run -c .golangci.yml --timeout=5m -v --fix

.PHONY: build
build/linux:
	GOOS=linux CGO_ENABLED=0 GOARCH=amd64 go build -trimpath -a -v

build/etcd-watch-postgres/linux:
	@echo "  >  Building agent binary..."
	@GOPATH=$(GOPATH) GOBIN=$(GOBIN) cd ./cmd/etcd-watch-postgres && go build -ldflags "-X main.buildVersion=v3.10.SNAPSHOT -X 'main.buildDate=$$(date +'%Y/%m/%d')' -X 'main.buildCommit=$$(git rev-parse HEAD)'" -o ../../bin/etcd-watch-postgres $(GOFILES)

build/postgres-cdc-etcd/linux:
	@echo "  >  Building agent binary..."
	@GOPATH=$(GOPATH) GOBIN=$(GOBIN) cd ./cmd/postgres-cdc-etcd && go build -ldflags "-X main.buildVersion=v3.10.SNAPSHOT -X 'main.buildDate=$$(date +'%Y/%m/%d')' -X 'main.buildCommit=$$(git rev-parse HEAD)'" -o ../../bin/postgres-cdc-etcd $(GOFILES)
